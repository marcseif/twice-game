const members = [
  {
    name: "Nayeon",
    images: [
      "images/nayeon1.jpeg",
      "images/nayeon2.jpeg",
      "images/nayeon3.jpeg",
      "images/nayeon4.jpeg",
      "images/nayeon5.jpeg",
    ],
  },
  {
    name: "Jeongyeon",
    images: [
      "images/jeongyeon1.jpeg",
      "images/jeongyeon2.jpeg",
      "images/jeongyeon3.jpeg",
      "images/jeongyeon4.jpeg",
      "images/jeongyeon5.jpeg",
    ],
  },
  {
    name: "Momo",
    images: [
      "images/momo1.jpeg",
      "images/momo2.jpeg",
      "images/momo3.jpeg",
      "images/momo4.jpeg",
      "images/momo5.jpeg",
    ],
  },
  {
    name: "Sana",
    images: [
      "images/sana1.jpeg",
      "images/sana2.jpeg",
      "images/sana3.jpeg",
      "images/sana4.jpeg",
      "images/sana5.jpeg",
    ],
  },
  {
    name: "Jihyo",
    images: [
      "images/jihyo1.jpeg",
      "images/jihyo2.jpeg",
      "images/jihyo3.jpeg",
      "images/jihyo4.jpeg",
      "images/jihyo5.jpeg",
    ],
  },
  {
    name: "Mina",
    images: [
      "images/mina1.jpeg",
      "images/mina2.jpeg",
      "images/mina3.jpeg",
      "images/mina4.jpeg",
      "images/mina5.jpeg",
    ],
  },
  {
    name: "Dahyun",
    images: [
      "images/dahyun1.jpeg",
      "images/dahyun2.jpeg",
      "images/dahyun3.jpeg",
      "images/dahyun4.jpeg",
      "images/dahyun5.jpeg",
    ],
  },
  {
    name: "Chaeyoung",
    images: [
      "images/chaeyoung1.jpeg",
      "images/chaeyoung2.jpeg",
      "images/chaeyoung3.jpeg",
      "images/chaeyoung4.jpeg",
      "images/chaeyoung5.jpeg",
    ],
  },
  {
    name: "Tzuyu",
    images: [
      "images/tzuyu1.jpeg",
      "images/tzuyu2.jpeg",
      "images/tzuyu3.jpeg",
      "images/tzuyu4.jpeg",
      "images/tzuyu5.jpeg",
    ],
  },
];

const songs = [
  {
    name: "Four",
    file: "audio/four.mp3",
    youtube: "https://www.youtube.com/watch?v=fhxq4s36-I4",
  },
  {
    name: "This is For",
    file: "audio/thisisfor.mp3",
    youtube: "https://www.youtube.com/watch?v=4tGRXSaYsPg",
  },
  {
    name: "After Moon",
    file: "audio/aftermoon.mp3",
    youtube: "https://www.youtube.com/watch?v=Cmlhdt2j62s",
  },
  {
    name: "Battitude",
    file: "audio/battitude.mp3",
    youtube: "https://www.youtube.com/watch?v=TOic7n-CDd4",
  },
  {
    name: "BDZ",
    file: "audio/bdz.mp3",
    youtube: "https://www.youtube.com/watch?v=-tsddqSTkOw",
  },
  {
    name: "Cry For Me",
    file: "audio/cryforme.mp3",
    youtube: "https://www.youtube.com/watch?v=FF50-LY2Kro",
  },
  {
    name: "Dance The Night Away",
    file: "audio/dancethenightaway.mp3",
    youtube: "https://www.youtube.com/watch?v=fW1Cgv63naI",
  },
  {
    name: "DAT AHH DAT OOH",
    file: "audio/datahhdatooh.mp3",
    youtube: "https://www.youtube.com/watch?v=POxNm2NNyps",
  },
  {
    name: "Do It Again",
    file: "audio/doitagain.mp3",
    youtube: "https://www.youtube.com/watch?v=kSsAj90BSBk",
  },
  {
    name: "Fancy",
    file: "audio/fancy.mp3",
    youtube: "https://www.youtube.com/watch?v=Pa6yt970yZo",
  },
  {
    name: "Feel Special",
    file: "audio/feelspecial.mp3",
    youtube: "https://www.youtube.com/watch?v=CZ61FaoaNHg",
  },
  {
    name: "Gone",
    file: "audio/gone.mp3",
    youtube: "https://www.youtube.com/watch?v=eGL-O-vZFMA",
  },
  {
    name: "Hell In Heaven",
    file: "audio/hellinheaven.mp3",
    youtube: "https://www.youtube.com/watch?v=0O18GnTW1CU",
  },
  {
    name: "I Can't Stop Me",
    file: "audio/icantstopme.mp3",
    youtube: "https://www.youtube.com/watch?v=F-5cQSFv9YA",
  },
  {
    name: "I Got You",
    file: "audio/igotyou.mp3",
    youtube: "https://www.youtube.com/watch?v=46AmgEfifwk",
  },
  {
    name: "Make Me Go",
    file: "audio/makemego.mp3",
    youtube: "https://www.youtube.com/watch?v=3fqDjzbtbG4",
  },
  {
    name: "Mars",
    file: "audio/mars.mp3",
    youtube: "https://www.youtube.com/watch?v=N1ExjhcpLso",
  },
  {
    name: "Moonlight Sunrise",
    file: "audio/moonlightsunrise.mp3",
    youtube: "https://www.youtube.com/watch?v=rvxx34XJQPM",
  },
  {
    name: "One Spark",
    file: "audio/onespark.mp3",
    youtube: "https://www.youtube.com/watch?v=8tiDc7JJ2sE",
  },
  {
    name: "Options",
    file: "audio/options.mp3",
    youtube: "https://www.youtube.com/watch?v=0sFFvghflng",
  },
  {
    name: "Right Hand Girl",
    file: "audio/righthandgirl.mp3",
    youtube: "https://www.youtube.com/watch?v=dtKQfCr7N7I",
  },
  {
    name: "Set Me Free",
    file: "audio/setmefree.mp3",
    youtube: "https://www.youtube.com/watch?v=Z3X3l2O5CmM",
  },
  {
    name: "Strategy",
    file: "audio/strategy.mp3",
    youtube: "https://www.youtube.com/watch?v=nmbiBVPe5bY",
  },
  {
    name: "Talk That Talk",
    file: "audio/talkthattalk.mp3",
    youtube: "https://www.youtube.com/watch?v=QNWO_ZF7b8w",
  },
  {
    name: "The Feels",
    file: "audio/thefeels.mp3",
    youtube: "https://www.youtube.com/watch?v=N388pPWJPxs",
  },
  {
    name: "What Is Love",
    file: "audio/whatislove.mp3",
    youtube: "https://www.youtube.com/watch?v=KWZ-ytC9Uyk",
  },
  {
    name: "Yes or Yes",
    file: "audio/yesoryes.mp3",
    youtube: "https://www.youtube.com/watch?v=6mTbxCBs0P4",
  },
  {
    name: "You In My Heart",
    file: "audio/youinmyheart.mp3",
    youtube: "https://www.youtube.com/watch?v=hoPOCZJv_2M",
  },
];

// Create suggestion list from members and songs
const suggestionsList = [
  ...members.map((m) => m.name),
  ...songs.map((s) => s.name),
];

let currentMember = null;
let usedImages = [];
let correctCount = 0;
let roundActive = true; // prevent multiple submissions in one round
let currentLevel = 1;
let level2Unlocked = false;
let dailySong = null;
let defaultMaxRounds = 10; // keep your original default
let maxRounds = defaultMaxRounds; // allow reassigning when switching levels
let segmentLength = 1; // start at 1s for Level 3
let dailyAttempts = 0; // number of guesses made today
let currentStartTime = 0;
let dailySegmentStartTime = null; // Will store the fixed start time for daily challenge
let dailyStartTimeSet = false; // Flag to track if we've set the start time

function getRandomUnusedImage() {
  let attempts = 0;
  while (attempts < 100) {
    const member = members[Math.floor(Math.random() * members.length)];
    const image =
      member.images[Math.floor(Math.random() * member.images.length)];
    const key = `${member.name}-${image}`;
    if (!usedImages.includes(key)) {
      usedImages.push(key);
      return { member, image };
    }
    attempts++;
  }
  return null;
}

function switchLevel(level) {
  // Level 2 requires unlock
  if (level === 2 && !level2Unlocked) return;

  currentLevel = level;

  // update active class on all three (if you have level3-btn)
  document.getElementById("level1-btn").classList.remove("active");
  document.getElementById("level2-btn").classList.remove("active");
  const level3Btn = document.getElementById("level3-btn");
  if (level3Btn) level3Btn.classList.remove("active");
  const btn = document.getElementById(`level${level}-btn`);
  if (btn) btn.classList.add("active");

  // Show/hide member image vs audio
  if (currentLevel === 1) {
    document.getElementById("member-img").style.display = "block";
    document.getElementById("song-audio").style.display = "none";
    document.getElementById("game-area").style.display = "block";
  } else if (currentLevel === 2) {
    document.getElementById("member-img").style.display = "none";
    document.getElementById("song-audio").style.display = "block";
    document.getElementById("game-area").style.display = "block";
  } else {
    document.getElementById("member-img").style.display = "none";
    document.getElementById("song-audio").style.display = "block";
    document.getElementById("game-area").style.display = "none";
  }

  // audio controls visible for level 2 & 3
  const audioControls = document.getElementById("audio-controls");
  if (currentLevel === 1) audioControls.style.display = "none";
  else audioControls.style.display = "flex";

  // set rounds for daily
  if (currentLevel === 3) {
    maxRounds = 1;
  } else {
    maxRounds = defaultMaxRounds;
  }

  restartGame();
}

function nextImage() {
  roundActive = true;
  document.getElementById("feedback").textContent = "";
  document.getElementById("guess-input").value = "";

  if (currentLevel === 1) {
    if (correctCount >= maxRounds) return endGame(true);
    const data = getRandomUnusedImage();
    if (!data) return endGame(true);
    currentMember = data.member;
    document.getElementById("member-img").src = data.image;
    document.getElementById("member-img").style.display = "block";
    document.getElementById("song-audio").style.display = "none";
  } else if (currentLevel === 2) {
    if (correctCount >= maxRounds) return endGame(true);

    currentStartTime = 0; // reset start time for new song segment
    dailyAttempts = 0; // reset attempts just in case
    segmentLength = 5; // fixed segment length for Level 2

    playSongRound(songs[Math.floor(Math.random() * songs.length)], 5);
  } else if (currentLevel === 3) {
    getDailySong();

    if (dailyAttempts >= 5) {
      const feedbackEl = document.getElementById("feedback");
      feedbackEl.textContent = `‚ùå Sorry, you lost! The song was "${dailySong.name}"`;
      feedbackEl.style.color = "red";
      showYoutubeVideo(dailySong.youtube);
      document.getElementById("guess-input").disabled = true;
      document.getElementById("submit-btn").disabled = true;
      roundActive = false;
      return;
    }

    segmentLength = dailyAttempts + 1; // 1 to 5 seconds

    // Only set the daily start time once per day
    if (!dailyStartTimeSet) {
      dailySegmentStartTime = getDailySegmentStart(dailySong);
      dailyStartTimeSet = true;
    }

    playSongRound(dailySong, segmentLength, dailySegmentStartTime);
  }
}

function checkGuess() {
  if (!roundActive) return;
  const guess = document
    .getElementById("guess-input")
    .value.trim()
    .toLowerCase();
  const correct = currentMember.name.toLowerCase();

  if (guess === correct) {
    correctCount++;
    const feedbackEl = document.getElementById("feedback");
    if (currentLevel === 3) {
      feedbackEl.textContent = "‚úÖ Correct!";
      showYoutubeVideo(currentMember.youtube);
    } else {
      feedbackEl.textContent = "‚úÖ Correct!";
    }
    feedbackEl.style.color = "green";
    movePerson(correctCount);

    if (currentLevel === 3) {
      localStorage.setItem(
        "dailyPlayedDate",
        new Date().toISOString().split("T")[0]
      );
      endGame(true);
    } else {
      roundActive = false;
      setTimeout(nextImage, 800);
    }
  } else {
    if (currentLevel === 3) {
      dailyAttempts++;
      if (dailyAttempts < 5) {
        segmentLength = dailyAttempts + 1; // increase segment length

        // Show generic wrong feedback without revealing answer
        document.getElementById("feedback").textContent =
          "‚ùå Wrong! Try again.";
        document.getElementById("feedback").style.color = "red";

        // Keep using the same segment with increased length
        playSongRound(dailySong, segmentLength, dailySegmentStartTime);
      } else {
        localStorage.setItem(
          "dailyPlayedDate",
          new Date().toISOString().split("T")[0]
        );
        const feedbackEl = document.getElementById("feedback");
        feedbackEl.textContent = `‚ùå Sorry, you lost! The song was "${dailySong.name}"`;
        feedbackEl.style.color = "red";
        showYoutubeVideo(dailySong.youtube);
        endGame(false);
      }
    } else {
      document.getElementById(
        "feedback"
      ).textContent = `‚ùå Wrong! It was ${currentMember.name}.`;
      document.getElementById("feedback").style.color = "red";
      endGame(false);
    }
  }
}

function endGame(won) {
  document.getElementById("guess-input").disabled = true;
  document.getElementById("submit-btn").disabled = true;
  roundActive = false;

  const endMsg = document.getElementById("end-message");
  const person = document.getElementById("person");
  const concert = document.getElementById("concert");
  const retryButton = document.querySelector("#retry-container button"); // add this line

  if (currentLevel === 3) {
    // For Level 3, we don't show any additional end message
    // The feedback message and YouTube video are already shown
    retryButton.textContent = "Try Again";
    retryButton.classList.remove("pulse-btn");
    retryButton.onclick = restartGame;
  } else if (won && correctCount === maxRounds) {
    if (currentLevel === 1) {
      // Level 1 win text
      endMsg.innerHTML = `üéâ Congratulations, you unlocked <strong>Level 2</strong>!`;
      level2Unlocked = true;
      const level2Btn = document.getElementById("level2-btn");
      level2Btn.disabled = false;
      level2Btn.classList.remove("locked");

      retryButton.textContent = "Go to Level 2";
      retryButton.classList.add("pulse-btn"); // Add pulse
      retryButton.onclick = () => {
        retryButton.classList.remove("pulse-btn"); // Remove pulse once clicked
        document.getElementById("level2-btn").click();
      };
    } else if (currentLevel === 2) {
      // Level 2 win text
      endMsg.innerHTML = `üéâ Congratulations, you <strong>ARE</strong> going to the concert! <br><img src="https://cdn.vectorstock.com/i/1000v/53/95/thumbs-up-smiley-emoticon-vector-1075395.jpg" height="100">`;
      person.classList.add("celebrating");
      retryButton.textContent = "Retry";
      retryButton.classList.remove("pulse-btn");
      retryButton.onclick = restartGame;

      // Final snap to exact center
      const concertCenter = concert.offsetLeft + concert.offsetWidth / 2;
      const personCenter = person.offsetWidth / 2;
      person.style.left = `${concertCenter - personCenter}px`;
    }
  } else if (currentLevel !== 3) {
    // Only show "not going to concert" for levels 1 and 2
    endMsg.innerHTML = `üëâ You <strong>are NOT</strong> going to the concert! <br><img src="https://static.vecteezy.com/system/resources/thumbnails/017/260/371/small/hand-pointing-finger-at-you-vector.jpg" height="100">`;
    retryButton.textContent = "Retry";
    retryButton.classList.remove("pulse-btn");
    retryButton.onclick = restartGame;
  }

  document.getElementById("retry-container").style.display = "block";
}

function movePerson(count) {
  // Don't move person in Level 3
  if (currentLevel === 3) return;

  const person = document.getElementById("person");
  const gameArea = document.getElementById("game-area");
  const concert = document.getElementById("concert");

  const concertX = concert.offsetLeft + concert.offsetWidth / 2;
  const personWidth = person.offsetWidth;
  const stepSize = (concertX - personWidth / 2) / maxRounds;

  person.style.left = `${stepSize * count}px`;
}

document
  .getElementById("guess-input")
  .addEventListener("keypress", function (e) {
    if (e.key === "Enter") {
      checkGuess();
    }
  });

window.onload = () => {
  document.getElementById("retry-container").style.display = "none"; // hide retry initially
  nextImage();
};

function restartGame() {
  correctCount = 0;
  usedImages = [];
  roundActive = true;
  dailyStartTimeSet = false; // Reset the daily start time flag
  document.getElementById("end-message").innerHTML = "";
  document.getElementById("feedback").textContent = "";
  document.getElementById("retry-container").style.display = "none";
  document.getElementById("youtube-container").style.display = "none";
  document.getElementById("youtube-container").innerHTML = "";

  // Reset guess input
  document.getElementById("guess-input").disabled = false;
  document.getElementById("guess-input").value = "";

  // ‚úÖ Explicitly re-enable submit button
  document.getElementById("submit-btn").disabled = false;

  // Only reset person position if not in Level 3
  if (currentLevel !== 3) {
    const person = document.getElementById("person");
    person.style.left = "0px";
    person.classList.remove("celebrating");
  }

  nextImage();
}

const guessInput = document.getElementById("guess-input");
const suggestionsBox = document.getElementById("suggestions");
let currentSuggestions = [];
let selectedIndex = -1;

function updateSuggestionList() {
  if (currentLevel === 1) {
    return members.map((m) => m.name);
  } else if (currentLevel === 2 || currentLevel === 3) {
    return songs.map((s) => s.name);
  }
  return [];
}

// Listen for typing
guessInput.addEventListener("input", function () {
  const query = this.value.toLowerCase();
  suggestionsBox.innerHTML = "";
  selectedIndex = -1;
  currentSuggestions = updateSuggestionList().filter((item) =>
    item.toLowerCase().includes(query)
  );

  if (!query || currentSuggestions.length === 0) {
    suggestionsBox.style.display = "none";
    return;
  }

  currentSuggestions.forEach((item, index) => {
    const div = document.createElement("div");
    div.textContent = item;
    div.onclick = () => selectSuggestion(index);
    suggestionsBox.appendChild(div);
  });

  suggestionsBox.style.display = "block";
});

// Keyboard navigation
guessInput.addEventListener("keydown", function (e) {
  const items = suggestionsBox.querySelectorAll("div");
  if (suggestionsBox.style.display === "none") return;

  if (e.key === "ArrowDown") {
    e.preventDefault();
    selectedIndex = (selectedIndex + 1) % items.length;
    highlightSuggestion(items);
  } else if (e.key === "ArrowUp") {
    e.preventDefault();
    selectedIndex = (selectedIndex - 1 + items.length) % items.length;
    highlightSuggestion(items);
  } else if (e.key === "Enter") {
    // Always hide suggestions on Enter
    suggestionsBox.style.display = "none";

    if (selectedIndex >= 0 && selectedIndex < currentSuggestions.length) {
      e.preventDefault();
      selectSuggestion(selectedIndex);
    }
  }
});

function highlightSuggestion(items) {
  items.forEach((item, idx) => {
    item.style.backgroundColor = idx === selectedIndex ? "#ffe0e0" : "";
  });
}

function selectSuggestion(index) {
  guessInput.value = currentSuggestions[index];
  suggestionsBox.style.display = "none";
  guessInput.focus();
}

// Hide suggestions if user clicks outside
document.addEventListener("click", function (e) {
  if (!document.getElementById("autocomplete-container").contains(e.target)) {
    suggestionsBox.style.display = "none";
  }
});

function getDailySong() {
  const todayKey = new Date().toISOString().split("T")[0]; // YYYY-MM-DD

  // Use a deterministic hash function on the date string to pick song index
  const hash = simpleHash(todayKey);

  // Pick a song based on hash modulo length of songs array
  const index = hash % songs.length;

  dailySong = songs[index];
  return dailySong;
}

// Simple hash function to convert string to integer
function simpleHash(str) {
  let hash = 0;
  for (let i = 0; i < str.length; i++) {
    hash = (hash << 5) - hash + str.charCodeAt(i);
    hash |= 0; // Convert to 32bit integer
  }
  return Math.abs(hash);
}

function formatTime(seconds) {
  const mins = Math.floor(seconds / 60);
  const secs = Math.floor(seconds % 60);
  return `${mins}:${secs.toString().padStart(2, "0")}`;
}

function updateProgressBar(audio, startTime, segLength, totalDuration) {
  const progressIndicator = document.getElementById("progress-indicator");
  const segmentIndicator = document.getElementById("segment-indicator");
  const timeCounter = document.getElementById("time-counter");

  // Calculate segment position and width as percentage of total duration
  const segmentStart = (startTime / totalDuration) * 100;
  const segmentWidth = (segLength / totalDuration) * 100;

  // Set segment indicator position and width
  segmentIndicator.style.left = segmentStart + "%";
  segmentIndicator.style.width = segmentWidth + "%";

  // Calculate current time within segment
  const currentTimeInSegment = Math.max(
    0,
    Math.min(segLength, audio.currentTime - startTime)
  );

  // Calculate progress percentage
  const progress = (currentTimeInSegment / segLength) * 100;

  // Update progress bar
  progressIndicator.style.left = segmentStart + "%";
  progressIndicator.style.width = (progress * segmentWidth) / 100 + "%";

  // Update time counter
  timeCounter.textContent = `${formatTime(currentTimeInSegment)} / ${formatTime(
    segLength
  )}`;
}

function playSongRound(song, fixedSegmentLength = null, fixedStartTime = null) {
  if (!song) return console.warn("playSongRound: no song provided");

  currentMember = song;
  const audio = document.getElementById("song-audio");
  const playBtn = document.getElementById("custom-play-btn");
  const volumeSlider = document.getElementById("volume-slider");
  const audioControls = document.getElementById("audio-controls");

  audioControls.style.display = "flex";
  document.getElementById("member-img").style.display = "none";

  audio.src = song.file;
  audio.load();
  playBtn.disabled = true;

  if (typeof window.savedVolume !== "undefined") {
    audio.volume = window.savedVolume;
    volumeSlider.value = window.savedVolume;
  } else {
    audio.volume = 0.5;
    volumeSlider.value = 0.5;
  }

  volumeSlider.oninput = () => {
    audio.volume = volumeSlider.value;
    window.savedVolume = parseFloat(volumeSlider.value);
  };

  function playSegment() {
    const duration = audio.duration || 180;
    const segLength =
      fixedSegmentLength !== null ? fixedSegmentLength : segmentLength;
    let startTime;

    if (fixedStartTime !== null) {
      startTime = fixedStartTime;
    } else {
      // For Level 2 or others, pick random start time as usual
      startTime = Math.random() * (duration - segLength - 5);
    }

    playBtn.disabled = false;
    playBtn.onclick = () => {
      audio.currentTime = startTime;
      audio.play();

      audio.ontimeupdate = () => {
        updateProgressBar(audio, startTime, segLength, duration);
        if (audio.currentTime >= startTime + segLength) {
          audio.pause();
          audio.currentTime = 0;
          audio.ontimeupdate = null;
        }
      };
    };

    playBtn.onclick();

    audio.removeEventListener("loadedmetadata", playSegment);
  }

  audio.addEventListener("loadedmetadata", playSegment);
}

function getYoutubeVideoId(url) {
  const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
  const match = url.match(regExp);
  return match && match[2].length === 11 ? match[2] : null;
}

function showYoutubeVideo(youtubeUrl) {
  const videoId = getYoutubeVideoId(youtubeUrl);
  if (!videoId) return;

  const container = document.getElementById("youtube-container");
  container.innerHTML = `
    <iframe
      src="https://www.youtube.com/embed/${videoId}"
      title="YouTube video player"
      frameborder="0"
      allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
      allowfullscreen>
    </iframe>
  `;
  container.style.display = "block";
}

// Deterministic start time based ONLY on date and song (not segmentLength)
function getDailySegmentStart(song) {
  const todayKey = new Date().toISOString().split("T")[0]; // YYYY-MM-DD
  const input = todayKey + song.name; // no segmentLength here

  const hash = simpleHash(input);
  const maxDuration = 180; // adjust as needed
  const maxStart = Math.max(0, maxDuration - 5 - 5); // leave 5s buffer plus max segment length (5s)

  const startTime = (hash % (maxStart * 1000)) / 1000; // seconds with ms precision
  return startTime;
}
